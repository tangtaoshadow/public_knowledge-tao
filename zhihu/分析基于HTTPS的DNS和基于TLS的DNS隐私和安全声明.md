### 分析基于HTTPS的DNS和基于TLS的DNS隐私和安全声明

**Author：**[杭州电子科技大学](http://www.hdu.edu.cn/)  `2016级管理学院` `工商管理` `唐涛` [16011324@hdu.edu.cn](mailto:16011324@hdu.edu.cn)

**CreateTime：**`2019-9-28 23:22:18`

**UpdateTime：**`2019-9-28 23:36:26`

**Copyright:**  *唐涛*  *2019* ©  [HOME](https://www.promiselee.cn/tao) 

**Email：**[tangtao2099@outlook.com](mailto:propro@westlake.edu.cn)

**Link：**  [知乎](https://www.zhihu.com/people/tang-tao-24-36/activities)  [GitHub](https://github.com/tangtaoshadow)





## **HTTPS上的DNS（DoH）和TLS上的DNS（DoT）是可用于安全DNS传输的两个新协议选项**

在DNS社区中，DoH一直存在争议，遭到著名人士的强烈反对。当DoT标准已经成为一种选择时，甚至对于IETF DoH标准的存在都提出了疑问。



## **Firefox内置了DoH支持**

Firefox内置了DoH支持并配置了Cloudflare DNS，并将其设置默认为美国的所有用户的默认配置。这将有可能导致破坏组织或专用网络的本地网络策略。Firefox宣布了一个金丝雀域名，它可以在本地将其阻止，以防止Firefox默认使用DoH，从而使整个工作容易遭受降级攻击。人们对将 DoH作为DNS基础结构集中化的一种方式提出了严重的担忧。只有少数公共DoH和DoT服务提供商，因此它尝试集中化DNS基础结构。向少数DNS供应商发送所有您的DNS流量并不能真正改善您的整体隐私，每个用户需要自行决定这是一个折衷。



## **DNS是网络中的一个重要控制平面**

从本质上讲，它可使网络管理员可以根据域名来阻止内容，从而使其成为军械库中非常有用的工具。它被广泛用于提供内容过滤服务，父级控制以及阻止已知的恶意软件命令和控制。它是如此流行，以至于很多人在家庭网络上安装了本地运行的DNS服务器，以使用阻止列表来阻止Internet广告。

默认情况下，使用DoH的应用程序或设备将绕过网络管理员配置的所有本地控制措施。应用程序使用DoH的理由是，它允许用户绕过审查，并提供安全性和隐私性。但是，未经用户同意，这可能不是用户期望的。



## **但是（but），使用DoT或DoH的用户真的受到保护吗？**

首先让我们以技术术语了解默认的基于UDP / TCP的DNS（Do53），DoH和DoT协议。

Do53是整个DNS基础结构使用的核心协议，默认情况下，所有DNS查询都使用UDP协议，因为它对于简单的请求/响应查询更为有效。

通常仅在预期响应足够大而不适用于UDP时才使用TCP，Do53不提供任何安全性或保密性，因为网络路径上的任何人都可以看到所有DNS请求，甚至操纵响应实际上是在进行中间人攻击。这已被许多危害路由器的恶意软件攻击所利用。并更改DNS设置以使用攻击者的DNS服务器进一步传播或进一步危害用户。当用户在Web浏览器中输入不存在的域名时，许多ISP也试图劫持DNS以显示广告。

DoT协议实际上只是在TLS内通过TCP传输的DNS-over-TCP 。因此，它提供了核心协议的所有功能以及路径安全性和私密性。DoT使用默认的TCP 853端口，因此很容易被任何网络防火墙阻止。



## DoH使用HTTPS协议以有线格式发送和接收DNS数据

这意味着DoH服务器实际上是一个标准Web服务器，后端Web应用程序读取DNS请求并将其代理到已配置的DNS服务器。使用内置Web服务器的DNS服务器也可以直接支持DoH。与DoT一样，DoH也提供路径安全性和隐私性。由于DoH使用与HTTPS使用的相同的TCP 443端口，因此几乎不可能用网络防火墙阻止它，因为防火墙无法区分正常的HTTPS流量和DoH。

由于DoT和DoH都使用TLS来确保安全性，因此它们在网络上本质上看起来相似。实际上，如果将DoT配置在端口443而不是其默认端口853上，那么使用网络防火墙进行阻止也将变得困难。因此，DoH的唯一好处似乎是，它允许使用标准Web服务器托管服务，在该服务器中，相同的IP地址和端口与多个其他HTTPS网站共享。



## 尽管DoT和DoH都声称提供安全性和隐私性，但还存在很多问题

DoT和DoH都仅提供从客户端到递归DNS服务器的安全性，因此它们不提供任何端到端的安全性，所以客户端实质上是信任配置的递归DNS服务器。

即使对DNS请求进行了加密，由于TLS，您仍在泄漏所访问网站的域名服务器名称指示（SNI）扩展名。SNI本质上允许在单个IP地址上运行的Web服务器托管多个HTTPS网站。SNI扩展名包括您访问的网站的域名，以便Web服务器可以使用为该域名配置的正确SSL / TLS证书。因此，可以将SNI可靠地用作与基于DNS的过滤相结合的阻止网站的选项。

SNI扩展已升级到加密SNI（ESNI），它将加密TLS请求中的整个SNI扩展。但是实际上，即使ESNI在所有Web服务器和Web浏览器上普遍可用，也需要很多年的时间，大量的HTTPS网站为其域名配置ESNI。现在已有3年多的历史了，任何网站都可以使用免费的SSL / TLS证书，但是仍然有许多网站未部署HTTPS。

即使对DNS请求进行了加密并使用了TLS ESNI扩展名，大多数网站仍然可以通过其托管的IP地址来识别。因此，所有这些措施提供的隐私仍然不足。



## DNSSEC呢？

DNSSEC旨在提供安全性，以便递归DNS服务器可以在响应客户端请求之前验证响应。它不提供端到端的安全性，因为客户端从不真正执行验证并且完全依赖于配置的递归DNS服务器。DNSSEC的另一个问题是，它没有被广泛部署，只有一小部分域名配置了它。互联网上最流行的网站仍然没有部署DNSSEC，这使得DNSSEC对于大多数最终用户而言并没有真正的用处。

考虑到所有这些技术问题，很明显DoT和DoH都不真正安全地被人们用来绕过审查制度。任何对隐私有严重担忧的人最好使用Tor浏览器或使用体面的VPN服务。



DoT和DoH仍然有用，因为它们可以保护用户免受路径网络攻击者的中间人攻击。但是，DoH确实旨在绕过本地网络策略而设计。两者都能够在专用网络或ISP上隐藏您的DNS流量。



对于许多人来说，更好的方法是运行自己的本地DNS服务器，该服务器进行递归解析。所有部署DoT的主要ISP和支持DoT的主要操作系统（OS）都将大大有助于改善隐私和安全性，并保持分散化。较新的Android移动设备已经开始支持DoT。一旦整个生态系统支持并部署了DoT，它将改善DNS所处的当前状态。



***最后更新时间*：** `2019-9-28 23:35:26`

***Author：***[唐涛](https://www.promiselee.cn/tao) [Email](mailto:propro@westlake.edu.cn)

***原文链接：*** [分析基于HTTPS的DNS和基于TLS的DNS隐私和安全声明](https://github.com/tangtaoshadow/public_knowledge-tao/blob/master/zhihu/%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8EHTTPS%E7%9A%84DNS%E5%92%8C%E5%9F%BA%E4%BA%8ETLS%E7%9A%84DNS%E9%9A%90%E7%A7%81%E5%92%8C%E5%AE%89%E5%85%A8%E5%A3%B0%E6%98%8E.md)



